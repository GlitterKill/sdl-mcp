{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "SDL-MCP Configuration",
  "description": "Configuration schema for SDL-MCP (Symbol Delta Ledger MCP Server)",
  "type": "object",
  "required": ["repos", "dbPath", "policy"],
  "properties": {
    "repos": {
      "type": "array",
      "description": "List of repositories to index",
      "items": {
        "type": "object",
        "required": ["repoId", "rootPath"],
        "properties": {
          "repoId": {
            "type": "string",
            "description": "Unique identifier for the repository",
            "minLength": 1
          },
          "rootPath": {
            "type": "string",
            "description": "Absolute or relative path to the repository root",
            "minLength": 1
          },
          "ignore": {
            "type": "array",
            "description": "Glob patterns to ignore during indexing",
            "items": {
              "type": "string"
            },
            "default": [
              "**/node_modules/**",
              "**/dist/**",
              "**/.next/**",
              "**/build/**"
            ]
          },
          "languages": {
            "type": "array",
            "description": "Programming languages to index",
            "items": {
              "type": "string",
              "enum": [
                "ts",
                "tsx",
                "js",
                "jsx",
                "py",
                "go",
                "java",
                "cs",
                "c",
                "cpp",
                "php",
                "rs",
                "kt",
                "sh"
              ]
            },
            "default": [
              "ts",
              "tsx",
              "js",
              "jsx",
              "py",
              "go",
              "java",
              "cs",
              "c",
              "cpp",
              "php",
              "rs",
              "kt",
              "sh"
            ]
          },
          "maxFileBytes": {
            "type": "integer",
            "description": "Maximum file size in bytes to index",
            "minimum": 1,
            "default": 2000000
          },
          "includeNodeModulesTypes": {
            "type": "boolean",
            "description": "Include node_modules/@types declarations in TypeScript call resolution (excluding @types/node)",
            "default": true
          },
          "packageJsonPath": {
            "type": "string",
            "description": "Optional path to package.json (auto-detected if not provided)"
          },
          "tsconfigPath": {
            "type": "string",
            "description": "Optional path to tsconfig.json (auto-detected if not provided)"
          },
          "workspaceGlobs": {
            "type": "array",
            "description": "Glob patterns to find workspace package.json files (monorepo support)",
            "items": {
              "type": "string"
            }
          }
        }
      }
    },
    "dbPath": {
      "type": "string",
      "description": "Path to SQLite database file",
      "minLength": 1
    },
    "policy": {
      "type": "object",
      "description": "Code access policy settings",
      "properties": {
        "maxWindowLines": {
          "type": "integer",
          "description": "Maximum lines of code to return per window",
          "minimum": 1,
          "default": 180
        },
        "maxWindowTokens": {
          "type": "integer",
          "description": "Maximum tokens to return per window",
          "minimum": 1,
          "default": 1400
        },
        "requireIdentifiers": {
          "type": "boolean",
          "description": "Require user to specify identifiers before returning code",
          "default": true
        },
        "allowBreakGlass": {
          "type": "boolean",
          "description": "Allow break-glass mode to override policy temporarily",
          "default": true
        }
      },
      "default": {
        "maxWindowLines": 180,
        "maxWindowTokens": 1400,
        "requireIdentifiers": true,
        "allowBreakGlass": true
      }
    },
    "redaction": {
      "type": "object",
      "description": "Secret redaction configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable secret redaction",
          "default": true
        },
        "includeDefaults": {
          "type": "boolean",
          "description": "Include default redaction patterns",
          "default": true
        },
        "patterns": {
          "type": "array",
          "description": "Custom redaction patterns",
          "items": {
            "type": "object",
            "required": ["pattern"],
            "properties": {
              "name": {
                "type": "string",
                "description": "Pattern name for documentation"
              },
              "pattern": {
                "type": "string",
                "description": "Regex pattern to match",
                "minLength": 1
              },
              "flags": {
                "type": "string",
                "description": "Regex flags (e.g., 'i', 'g', 'm')"
              }
            }
          },
          "default": []
        }
      },
      "default": {
        "enabled": true,
        "includeDefaults": true,
        "patterns": []
      }
    },
    "indexing": {
      "type": "object",
      "description": "Indexing behavior configuration",
      "properties": {
        "concurrency": {
          "type": "integer",
          "description": "Number of concurrent indexing workers",
          "minimum": 1,
          "maximum": 10,
          "default": 8
        },
        "enableFileWatching": {
          "type": "boolean",
          "description": "Enable automatic reindexing on file changes",
          "default": true
        },
        "maxWatchedFiles": {
          "type": "integer",
          "description": "Maximum candidate source files allowed for watcher startup",
          "minimum": 1,
          "default": 25000
        },
        "workerPoolSize": {
          "type": "integer",
          "description": "Optional cap for the indexing worker pool size",
          "minimum": 1,
          "maximum": 16
        }
      },
      "default": {
        "concurrency": 8,
        "enableFileWatching": true,
        "maxWatchedFiles": 25000
      }
    },
    "slice": {
      "type": "object",
      "description": "Graph slice configuration",
      "properties": {
        "defaultMaxCards": {
          "type": "integer",
          "description": "Default maximum cards in a slice",
          "minimum": 1,
          "default": 60
        },
        "defaultMaxTokens": {
          "type": "integer",
          "description": "Default maximum tokens in a slice",
          "minimum": 1,
          "default": 12000
        },
        "edgeWeights": {
          "type": "object",
          "description": "Weights for different edge types in slice traversal",
          "properties": {
            "call": {
              "type": "number",
              "description": "Weight for call edges",
              "minimum": 0,
              "default": 1.0
            },
            "import": {
              "type": "number",
              "description": "Weight for import edges",
              "minimum": 0,
              "default": 0.6
            },
            "config": {
              "type": "number",
              "description": "Weight for config edges",
              "minimum": 0,
              "default": 0.8
            }
          },
          "default": {
            "call": 1.0,
            "import": 0.6,
            "config": 0.8
          }
        }
      },
      "default": {
        "defaultMaxCards": 60,
        "defaultMaxTokens": 12000,
        "edgeWeights": {
          "call": 1.0,
          "import": 0.6,
          "config": 0.8
        }
      }
    },
    "diagnostics": {
      "type": "object",
      "description": "TypeScript diagnostics configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable TypeScript diagnostics",
          "default": true
        },
        "mode": {
          "type": "string",
          "description": "Diagnostics mode",
          "enum": ["tsLS", "tsc"],
          "default": "tsLS"
        },
        "maxErrors": {
          "type": "integer",
          "description": "Maximum errors to report per file",
          "minimum": 1,
          "default": 50
        },
        "timeoutMs": {
          "type": "integer",
          "description": "Timeout for diagnostics in milliseconds",
          "minimum": 100,
          "default": 2000
        },
        "scope": {
          "type": "string",
          "description": "Diagnostics scope",
          "enum": ["changedFiles", "workspace"],
          "default": "changedFiles"
        }
      },
      "default": {
        "enabled": true,
        "mode": "tsLS",
        "maxErrors": 50,
        "timeoutMs": 2000,
        "scope": "changedFiles"
      }
    },
    "cache": {
      "type": "object",
      "description": "In-memory caching configuration for symbol cards and slices",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable caching",
          "default": true
        },
        "symbolCardMaxEntries": {
          "type": "integer",
          "description": "Maximum number of symbol cards to keep in cache",
          "minimum": 1,
          "default": 2000
        },
        "symbolCardMaxSizeBytes": {
          "type": "integer",
          "description": "Maximum total size in bytes for cached symbol cards",
          "minimum": 1024,
          "default": 104857600
        },
        "graphSliceMaxEntries": {
          "type": "integer",
          "description": "Maximum number of graph slices to keep in cache",
          "minimum": 1,
          "default": 1000
        },
        "graphSliceMaxSizeBytes": {
          "type": "integer",
          "description": "Maximum total size in bytes for cached graph slices",
          "minimum": 1024,
          "default": 52428800
        }
      },
      "default": {
        "enabled": true,
        "symbolCardMaxEntries": 2000,
        "symbolCardMaxSizeBytes": 104857600,
        "graphSliceMaxEntries": 1000,
        "graphSliceMaxSizeBytes": 52428800
      }
    },
    "plugins": {
      "type": "object",
      "description": "Adapter plugin configuration",
      "properties": {
        "paths": {
          "type": "array",
          "description": "Paths to plugin entrypoints (files or directories)",
          "items": { "type": "string" },
          "default": []
        },
        "enabled": {
          "type": "boolean",
          "description": "Enable plugin loading",
          "default": true
        },
        "strictVersioning": {
          "type": "boolean",
          "description": "Require plugin API version compatibility",
          "default": true
        }
      },
      "default": {
        "paths": [],
        "enabled": true,
        "strictVersioning": true
      }
    },
    "semantic": {
      "type": "object",
      "description": "Semantic retrieval and generated summary configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "alpha": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.6
        },
        "provider": {
          "type": "string",
          "enum": ["api", "local", "mock"],
          "default": "mock"
        },
        "model": {
          "type": "string",
          "default": "all-MiniLM-L6-v2"
        },
        "generateSummaries": {
          "type": "boolean",
          "default": false
        },
        "ann": {
          "type": "object",
          "description": "HNSW approximate nearest neighbor index configuration for semantic retrieval",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable HNSW ANN index for faster semantic retrieval",
              "default": false
            },
            "m": {
              "type": "integer",
              "description": "Number of bi-directional links per node in HNSW graph",
              "minimum": 4,
              "maximum": 64,
              "default": 16
            },
            "efConstruction": {
              "type": "integer",
              "description": "Size of dynamic candidate list during index construction",
              "minimum": 16,
              "maximum": 500,
              "default": 200
            },
            "efSearch": {
              "type": "integer",
              "description": "Size of dynamic candidate list during search",
              "minimum": 8,
              "maximum": 256,
              "default": 50
            },
            "maxElements": {
              "type": "integer",
              "description": "Maximum number of elements in the ANN index",
              "minimum": 1000,
              "maximum": 1000000,
              "default": 200000
            }
          },
          "default": {
            "enabled": false,
            "m": 16,
            "efConstruction": 200,
            "efSearch": 50,
            "maxElements": 200000
          }
        }
      },
      "default": {
        "enabled": false,
        "alpha": 0.6,
        "provider": "mock",
        "model": "all-MiniLM-L6-v2",
        "generateSummaries": false,
        "ann": {
          "enabled": false,
          "m": 16,
          "efConstruction": 200,
          "efSearch": 50,
          "maxElements": 200000
        }
      }
    },
    "prefetch": {
      "type": "object",
      "description": "Predictive prefetch configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "maxBudgetPercent": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "default": 20
        },
        "warmTopN": {
          "type": "integer",
          "minimum": 1,
          "default": 50
        }
      },
      "default": {
        "enabled": false,
        "maxBudgetPercent": 20,
        "warmTopN": 50
      }
    },
    "tracing": {
      "type": "object",
      "description": "OpenTelemetry tracing configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable OpenTelemetry tracing",
          "default": false
        },
        "serviceName": {
          "type": "string",
          "description": "Service name for tracing",
          "default": "sdl-mcp"
        },
        "exporterType": {
          "type": "string",
          "description": "Exporter type for traces",
          "enum": ["console", "otlp", "memory"],
          "default": "console"
        },
        "otlpEndpoint": {
          "type": "string",
          "description": "OTLP collector endpoint URL (required when exporterType is otlp)"
        },
        "sampleRate": {
          "type": "number",
          "description": "Sampling rate for traces (0.0 to 1.0)",
          "minimum": 0,
          "maximum": 1,
          "default": 1
        }
      },
      "default": {
        "enabled": false,
        "serviceName": "sdl-mcp",
        "exporterType": "console",
        "sampleRate": 1
      }
    },
    "parallelScorer": {
      "type": "object",
      "description": "Parallel beam search scorer configuration for improved slice performance",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable parallel scoring using worker threads",
          "default": false
        },
        "poolSize": {
          "type": "integer",
          "description": "Number of worker threads in the scorer pool",
          "minimum": 1,
          "maximum": 8
        },
        "minBatchSize": {
          "type": "integer",
          "description": "Minimum candidates to trigger parallel scoring",
          "minimum": 1,
          "maximum": 100
        }
      },
      "default": {
        "enabled": false
      }
    }
  }
}
