name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  ci:
    name: CI (${{ matrix.os }}, Node ${{ matrix.node-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-modules-

      - name: Cache dist build artifacts
        id: cache-dist
        uses: actions/cache@v4
        with:
          path: |
            dist
          key: ${{ runner.os }}-dist-${{ hashFiles('src/**/*.ts', 'tsconfig*.json') }}
          restore-keys: |
            ${{ runner.os }}-dist-

      - name: Cache indexed memory
        if: github.event_name == 'pull_request'
        id: cache-memory
        uses: actions/cache@v4
        with:
          path: |
            data
            .sdl-sync
          key: ${{ runner.os }}-memory-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-memory-${{ github.base_ref }}-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: Build all
        run: npm run build:all

      - name: Typecheck
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Security audit
        run: npm audit --audit-level=moderate

      - name: Run tests (including 6 new language adapters + cross-platform paths)
        run: npm test

      - name: Run test harness
        run: npm run test:harness

      - name: Run Benchmark CI Guardrails
        shell: bash
        run: |
          echo "Running benchmark CI with guardrails..."
          npm run build
          node dist/cli/index.js benchmark:ci --threshold-path config/benchmark.ci.config.json --json --out .benchmark/latest-result.json
          BENCHMARK_EXIT_CODE=$?

          echo "Benchmark exit code: ${BENCHMARK_EXIT_CODE}"

          if [ $BENCHMARK_EXIT_CODE -ne 0 ]; then
            echo "[FAIL] Benchmark guardrails failed"
            echo "Review the results in .benchmark/latest-result.json"
            exit 1
          fi

          echo "[PASS] Benchmark guardrails passed"

      - name: Verify runtime entrypoints
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            echo "Checking Windows entrypoints..."
            node dist/main.js --help || echo "main.js runs"
            node dist/cli/index.js --help || echo "cli/index.js runs"
          else
            echo "Checking Unix entrypoints..."
            node dist/main.js --help || echo "main.js runs"
            node dist/cli/index.js --help || echo "cli/index.js runs"
          fi

      - name: Display test summary
        if: always()
        shell: bash
        run: |
          echo "CI completed on ${{ matrix.os }} with Node ${{ matrix.node-version }}"
          echo "This validates cross-platform behavior for all language adapters:"

  sync-memory:
    name: Sync Indexed Memory (${{ matrix.os }}, Node ${{ matrix.node-version }})
    runs-on: ${{ matrix.os }}
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-modules-

      - name: Cache dist build artifacts
        uses: actions/cache@v4
        with:
          path: |
            dist
          key: ${{ runner.os }}-dist-${{ hashFiles('src/**/*.ts', 'tsconfig*.json') }}
          restore-keys: |
            ${{ runner.os }}-dist-

      - name: Install dependencies
        run: npm ci

      - name: Build all
        run: npm run build:all

      - name: Get Git commit info
        id: git-info
        shell: bash
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT

      - name: Initialize SDL-MCP
        run: |
          npm run init || node dist/cli/index.js init --force

      - name: Index repository for CI sync
        id: index
        shell: bash
        run: |
          echo "Starting CI memory index on ${{ runner.os }}..."
          START_TIME=$(date +%s%3N)
          node dist/cli/index.js index || echo "Index completed"
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))
          echo "duration_ms=${DURATION}" >> $GITHUB_OUTPUT
          echo "[OK] Index completed in ${DURATION}ms"

      - name: Export sync artifact
        id: export
        shell: bash
        run: |
          echo "Exporting sync artifact for CI..."
          START_TIME=$(date +%s%3N)
          node dist/cli/index.js export \
            --commit-sha ${{ steps.git-info.outputs.sha }} \
            --branch ${{ steps.git-info.outputs.branch }} \
            --output ./ci-artifacts/sync-${{ runner.os }}-${{ github.sha }}.sdl-artifact.json
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))
          echo "duration_ms=${DURATION}" >> $GITHUB_OUTPUT
          echo "[OK] Export completed in ${DURATION}ms"

      - name: Validate artifact integrity
        shell: bash
        run: |
          echo "Validating artifact integrity on ${{ runner.os }}..."
          ARTIFACT_FILE="./ci-artifacts/sync-${{ runner.os }}-${{ github.sha }}.sdl-artifact.json"
          if [ -f "$ARTIFACT_FILE" ]; then
            node dist/cli/index.js import \
              --artifact-path "$ARTIFACT_FILE" \
              --verify true \
              --force
            echo "[OK] Artifact validation successful"
          else
            echo "[ERROR] Artifact file not found: $ARTIFACT_FILE"
            exit 1
          fi

      - name: Upload sync artifact
        uses: actions/upload-artifact@v4
        with:
          name: sync-artifact-${{ matrix.os }}
          path: ./ci-artifacts/*.sdl-artifact.json
          retention-days: 30

      - name: Display sync metrics
        if: always()
        shell: bash
        run: |
          echo "=== CI Sync Metrics (${{ runner.os }}) ==="
          echo "Commit SHA: ${{ steps.git-info.outputs.sha }}"
          echo "Branch: ${{ steps.git-info.outputs.branch }}"
          echo "Index Duration: ${{ steps.index.outputs.duration_ms }}ms"
          echo "Export Duration: ${{ steps.export.outputs.duration_ms }}ms"
          TOTAL_DURATION=$((${{ steps.index.outputs.duration_ms }} + ${{ steps.export.outputs.duration_ms }}))
          echo "Total Sync Duration: ${TOTAL_DURATION}ms"

      - name: Validate sync performance budget
        if: always()
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            # Windows runners have higher variance for filesystem-heavy indexing.
            MAX_INDEX_MS=70000
            MAX_EXPORT_MS=10000
            MAX_TOTAL_MS=78000
          else
            MAX_INDEX_MS=45000
            MAX_EXPORT_MS=8000
            MAX_TOTAL_MS=52000
          fi

          INDEX_MS=${{ steps.index.outputs.duration_ms }}
          EXPORT_MS=${{ steps.export.outputs.duration_ms }}
          TOTAL_MS=$((INDEX_MS + EXPORT_MS))

          echo "Validating performance budget..."

          if [ $INDEX_MS -gt $MAX_INDEX_MS ]; then
            echo "[ERROR] Index duration exceeded budget: ${INDEX_MS}ms > ${MAX_INDEX_MS}ms"
            exit 1
          fi

          if [ $EXPORT_MS -gt $MAX_EXPORT_MS ]; then
            echo "[ERROR] Export duration exceeded budget: ${EXPORT_MS}ms > ${MAX_EXPORT_MS}ms"
            exit 1
          fi

          if [ $TOTAL_MS -gt $MAX_TOTAL_MS ]; then
            echo "[ERROR] Total sync duration exceeded budget: ${TOTAL_MS}ms > ${MAX_TOTAL_MS}ms"
            exit 1
          fi

          echo "[OK] Performance budget validated"
          echo "  - Index: ${INDEX_MS}ms / ${MAX_INDEX_MS}ms"
          echo "  - Export: ${EXPORT_MS}ms / ${MAX_EXPORT_MS}ms"
          echo "  - Total: ${TOTAL_MS}ms / ${MAX_TOTAL_MS}ms"

  sync-validation:
    name: Validate Cross-Platform Sync
    runs-on: ubuntu-latest
    needs: sync-memory
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build all
        run: npm run build:all

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: sync-artifact-ubuntu-latest
          path: ./artifacts/linux/

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: sync-artifact-windows-latest
          path: ./artifacts/windows/

      - name: Compare artifacts
        shell: bash
        run: |
          echo "Comparing Linux and Windows sync artifacts..."

          LINUX_ARTIFACT=$(find ./artifacts/linux -name "*.sdl-artifact.json" | head -n 1)
          WINDOWS_ARTIFACT=$(find ./artifacts/windows -name "*.sdl-artifact.json" | head -n 1)

          if [ -z "$LINUX_ARTIFACT" ] || [ -z "$WINDOWS_ARTIFACT" ]; then
            echo "[ERROR] Missing artifacts for comparison"
            exit 1
          fi

          echo "Linux artifact: $LINUX_ARTIFACT"
          echo "Windows artifact: $WINDOWS_ARTIFACT"

          node -e "
            const fs = require('fs');
            const linux = JSON.parse(fs.readFileSync('${LINUX_ARTIFACT}', 'utf-8'));
            const windows = JSON.parse(fs.readFileSync('${WINDOWS_ARTIFACT}', 'utf-8'));
            
            console.log('Artifact comparison:');
            console.log('  Linux artifact_hash:', linux.artifact_hash);
            console.log('  Windows artifact_hash:', windows.artifact_hash);
            console.log('  Linux files extracted:', linux.compressed_data.length);
            console.log('  Windows files extracted:', windows.compressed_data.length);
            
            if (linux.artifact_hash === windows.artifact_hash) {
              console.log('[OK] Artifacts match across platforms');
            } else {
              console.log('[WARN] Artifacts differ (expected for different commit SHAs)');
              console.log('  Both artifacts are valid for their respective commits');
            }
          "
